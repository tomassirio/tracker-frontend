name: Merge to Master

on:
  push:
    branches:
      - master

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    # Skip if commit was made by GitHub Actions (prevents infinite loop)
    if: "!contains(github.event.head_commit.message, 'ci: Prepare for next development iteration') && !contains(github.event.head_commit.message, 'ci: Release version') && !contains(github.event.head_commit.message, 'ci: Update README badges')"
    outputs:
      release-version: ${{ steps.set-release-version.outputs.version }}
      base-version: ${{ steps.set-release-version.outputs.base-version }}
      skip: ${{ steps.set-release-version.outputs.skip }}
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}
          persist-credentials: true

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"

      - name: Set release version
        id: set-release-version
        run: |
          CURRENT_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: *//')
          BASE_VERSION=$(echo "$CURRENT_VERSION" | sed 's/-SNAPSHOT//' | sed 's/+.*//')
          BUILD_NUMBER=$(echo "$CURRENT_VERSION" | grep -oP '\+\K[0-9]+' || echo "1")
          RELEASE_VERSION="${BASE_VERSION}+${BUILD_NUMBER}"
          
          # Check if tag already exists - skip release if so
          if git rev-parse "v${BASE_VERSION}" >/dev/null 2>&1; then
            echo "Tag v${BASE_VERSION} already exists, skipping release"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          sed -i "s/^version: .*/version: ${RELEASE_VERSION}/" pubspec.yaml
          
          echo "RELEASE_VERSION=${RELEASE_VERSION}" >> $GITHUB_ENV
          echo "version=${BASE_VERSION}" >> $GITHUB_OUTPUT
          echo "base-version=${BASE_VERSION}" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Commit release version
        if: steps.set-release-version.outputs.skip != 'true'
        run: |
          if ! git diff --quiet pubspec.yaml; then
            git add pubspec.yaml
            git commit -m "ci: Release version ${RELEASE_VERSION}"
          else
            echo "No version changes to commit"
          fi

      - name: Create Git tag
        if: steps.set-release-version.outputs.skip != 'true'
        run: |
          BASE_VERSION="${{ steps.set-release-version.outputs.base-version }}"
          git tag -a "v${BASE_VERSION}" -m "Release version ${RELEASE_VERSION}"

      - name: Push changes and tags
        if: steps.set-release-version.outputs.skip != 'true'
        run: |
          git push origin master || echo "No new commits to push"
          git push origin --tags

  test-and-coverage:
    needs: prepare-release
    if: needs.prepare-release.outputs.skip != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.prepare-release.outputs.base-version }}
          token: ${{ secrets.PAT_TOKEN }}
          persist-credentials: true

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
          cache: true

      - name: Run tests with coverage
        run: make test

      - name: Extract coverage and update README badges
        run: |
          BASE_VERSION="${{ needs.prepare-release.outputs.base-version }}"
          
          if [ -f "coverage/lcov.info" ]; then
            sudo apt-get update && sudo apt-get install -y lcov
            COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep -oP 'lines......: \K[0-9.]+' | head -1 || echo "0")
            COVERAGE=$(printf "%.0f" "$COVERAGE")
            
            if [ "$COVERAGE" -ge 80 ]; then COVERAGE_COLOR="brightgreen"
            elif [ "$COVERAGE" -ge 60 ]; then COVERAGE_COLOR="yellow"
            elif [ "$COVERAGE" -ge 40 ]; then COVERAGE_COLOR="orange"
            else COVERAGE_COLOR="red"; fi
          else
            COVERAGE="N/A"
            COVERAGE_COLOR="lightgrey"
          fi
          
          if [ -f "README.md" ]; then
            sed -i "s/version-[0-9.]*-blue/version-${BASE_VERSION}-blue/" README.md
            sed -i "s|coverage-[^)]*|coverage-${COVERAGE}%25-${COVERAGE_COLOR}|" README.md
            
            if ! git diff --quiet README.md; then
              git config user.name "GitHub Actions"
              git config user.email "github-actions@github.com"
              git add README.md
              git commit -m "ci: Update README badges"
              git push origin HEAD:master
            fi
          fi

  build-web-app:
    needs: prepare-release
    if: needs.prepare-release.outputs.skip != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.prepare-release.outputs.base-version }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
          cache: true

      - name: Build web application
        run: make build

      - name: Create release archive
        run: tar -czf tracker-frontend-web.tar.gz -C build/web .

      - name: Upload web build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: tracker-frontend-web.tar.gz
          retention-days: 1

  create-release:
    needs:
      - prepare-release
      - test-and-coverage
      - build-web-app
    if: needs.prepare-release.outputs.skip != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.prepare-release.outputs.base-version }}

      - name: Download web build artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build

      - name: Create release notes
        run: |
          BASE_VERSION="${{ needs.prepare-release.outputs.base-version }}"
          echo "Release ${BASE_VERSION}" > release-notes.md
          echo "" >> release-notes.md
          
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 v${BASE_VERSION}^ 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            echo "Changes since ${PREV_TAG}:" >> release-notes.md
            echo "" >> release-notes.md
            git log --pretty=format:"* %s" ${PREV_TAG}..v${BASE_VERSION} >> release-notes.md
          else
            echo "Initial release" >> release-notes.md
          fi

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_VERSION="${{ needs.prepare-release.outputs.base-version }}"
          gh release create "v${BASE_VERSION}" \
            --title "Release ${BASE_VERSION}" \
            --notes-file release-notes.md \
            tracker-frontend-web.tar.gz


  build-release-docker-images:
    needs: prepare-release
    if: needs.prepare-release.outputs.skip != 'true'
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/docker-build.yml
    with:
      push-to-registry: true
      image-tag: v${{ needs.prepare-release.outputs.base-version }}
      checkout-ref: v${{ needs.prepare-release.outputs.base-version }}
    secrets:
      registry-username: ${{ github.actor }}
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  deploy-to-production:
    needs:
      - prepare-release
      - build-release-docker-images
      - test-and-coverage
    if: needs.prepare-release.outputs.skip != 'true'
    uses: ./.github/workflows/helm-deploy.yml
    with:
      environment: prod
      image-tag: v${{ needs.prepare-release.outputs.base-version }}
      namespace: wanderer
    secrets:
      TWINGATE_SERVICE_KEY: ${{ secrets.TWINGATE_SERVICE_KEY }}
      KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG_CONTENT }}
      GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}

  finalize-release:
    needs:
      - prepare-release
      - create-release
    if: needs.prepare-release.outputs.skip != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"

      - name: Set next development version
        run: |
          BASE_VERSION="${{ needs.prepare-release.outputs.base-version }}"
          
          # Split version into major.minor.patch and increment patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "${BASE_VERSION}"
          NEXT_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))-SNAPSHOT"
          
          # Update pubspec.yaml and commit only if changed
          sed -i "s/^version: .*/version: ${NEXT_VERSION}/" pubspec.yaml
          
          if ! git diff --quiet pubspec.yaml; then
            git add pubspec.yaml
            git commit -m "ci: Prepare for next development iteration (${NEXT_VERSION})"
            git push origin master
          else
            echo "Version already set to ${NEXT_VERSION}"
          fi

